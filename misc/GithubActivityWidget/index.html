<div id="GithubActivityWidget">
  <table id="GithubActivityTable">
    <thead>
      <tr>
        <th>Repo</th>
        <th>Created At</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
const user = new URLSearchParams(window.location.search).get('user')
if(!user){
  throw("GithubActivityWidget: no user provided")
}

fetch(`https://api.github.com/users/${user.toString()}/events/public`)
    .then(response => response.json())
    .then(processGithubEvents);

function processGithubEvents(events) {
  const tableBody = document.querySelector('#GithubActivityTable tbody');
  events.forEach(event => {
    const row = createGithubEventElement(event);
    tableBody.appendChild(row);
  });
}

function createGithubEventElement(event) {


function getLengthAgo(dateOf) {
    let currentDate = new Date();
    let timeDifference = currentDate.getTime() - dateOf.getTime();
    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let weeks = Math.floor(days / 7);
    let months = Math.floor(days / 30);

    if(months > 0) {
        return `${months} months ago`;
    } else if(weeks > 0) {
        return `${weeks} weeks ago`;
    } else if(days > 0) {
        return `${days} days ago`;
    } else {
        return `${hours} hours ago`;
    }
}
  
  const row = document.createElement('tr');

  const createdAt = document.createElement('td');
  let dateOf = new Date(event.created_at) ?? null;
  createdAt.innerHTML = `<i>(${(getLengthAgo(dateOf) ?? "")})</i>`;
  row.appendChild(createdAt);
  
  const repo = document.createElement('td');
  repo.textContent = event.repo.name;
  row.appendChild(repo);

 

  const description = document.createElement('td');
  description.textContent = getDescription(event);
  row.appendChild(description);

  return row; 
}

function getDescription(event) {
  switch (event.type) {
    case 'PushEvent':
      return `I pushed ${event.payload.commits.length} new commit(s) to the repository.`;
    case 'PullRequestEvent':
      return `I ${event.payload.action} a pull request.`;
    case 'IssuesEvent':
      return `I ${event.payload.action} an issue.`;
    case 'ForkEvent':
      return 'I forked the repository.';
    case 'WatchEvent':
      return `I started watching this repository.`;
    default:
      return 'I performed an unknown event.';
  }
}
</script>
