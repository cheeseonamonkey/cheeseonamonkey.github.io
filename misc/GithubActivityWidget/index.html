<div id="GithubActivityWidget">
  <table id="GithubActivityTable">
    <thead>
      <tr>
        <th></th>
        <th>Created At</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
const user = new URLSearchParams(window.location.search).get('user')
if(!user){
  throw("GithubActivityWidget: no user provided")
}

fetch(`https://api.github.com/users/${user.toString()}/events/public?limit=59`)
    .then(response => response.json())
    .then(processGithubEvents);

function processGithubEvents(events) {
  const tableBody = document.querySelector('#GithubActivityTable tbody');
  events.forEach(event => {
    const row = createGithubEventElement(event);
    tableBody.appendChild(row);
  });
}

function createGithubEventElement(event) {

  function getLengthAgo(dateOf) {
    let currentDate = new Date();
    let timeDifference = currentDate.getTime() - dateOf.getTime();
    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let weeks = Math.floor(days / 7);
    let months = Math.floor(days / 30);

    if(months > 0) {
        return `${months} months ago`;
    } else if(weeks > 0) {
        return `${weeks} weeks ago`;
    } else if(days > 0) {
        return `${days} days ago`;
    } else {
        return `${hours} hours ago`;
    }
  }

  const row = document.createElement('tr');

  const createdAt = document.createElement('td');
  let dateOf = new Date(event.created_at) ?? null;
  createdAt.innerHTML = `<i>(${(getLengthAgo(dateOf) ?? "")})</i>`;
  row.appendChild(createdAt);

  const repo = document.createElement('td');
  repo.textContent = event.repo.name;
  row.appendChild(repo);

  const description = document.createElement('td');
  description.innerHTML = getDescription(event);
  row.appendChild(description);

  return row;
}

function getDescription(event) {
  switch (event.type) {
    case 'PushEvent':
      let commits = event.payload.commits;
      let branch = event.payload.ref.replace("refs/heads/", "");
      let commitMessages = "Commit Messages: ";
      commits.forEach(commit => {
        commitMessages += commit.message + "<br>";
      });
      return `Pushed ${commits.length} new commit(s) to the ${branch} branch.<br>${commitMessages}`;
    case 'PullRequestEvent':
      let actionTitlePR = "";
      switch (event.payload.action) {
        case 'opened':
          actionTitlePR = "Opened";
          break;
        case 'closed':
          actionTitlePR = "Closed";
          break;
        case 'reopened':
          actionTitlePR = "Reopened";
          break;
        case 'synchronize':
          actionTitlePR = "Updated";
          break;
        case 'assigned':
          actionTitlePR = "Assigned";
          break;
        case 'unassigned':
          actionTitlePR = "Unassigned";
          break;
        case 'review_requested':
          actionTitlePR = "Review Requested";
          break;
        case 'review_request_removed':
          actionTitlePR = "Review Request Removed";
          break;
        default:
          actionTitlePR = "Performed an action on";
          break;
      }
      return `${actionTitlePR} a pull request:<br>${event.payload.pull_request.title}`;
    case 'IssuesEvent':
      let actionTitleIssue = "";
      switch (event.payload.action) {
        case 'opened':
          actionTitleIssue = "Opened";
          break;
        case 'closed':
          actionTitleIssue = "Closed";
          break;
        case 'reopened':
          actionTitleIssue = "Reopened";
          break;
        case 'assigned':
          actionTitleIssue = "Assigned";
          break;
        case 'unassigned':
          actionTitleIssue = "Unassigned";
          break;
        case 'labeled':
          actionTitleIssue = "Labeled";
          break;
        case 'unlabeled':
          actionTitleIssue = "Unlabeled";
          break;
        case 'edited':
          actionTitleIssue = "Edited";
          break;
        case 'milestoned':
          actionTitleIssue = "Milestoned";
          break;
        case 'demilestoned':
          actionTitleIssue = "Demilestoned";
          break;
        default:
          actionTitleIssue = "Performed an action on";
          break;
      }
      return `${actionTitleIssue} an issue:<br>${event.payload.issue.title}`;
    case 'ForkEvent':
      return `Forked the repository:<br><a href="${event.payload.forkee.html_url}" target="_blank">${event.payload.forkee.full_name}</a>`;
    case 'WatchEvent':
      return `Started watching this repository.`;
    default:
      return 'Performed an unknown event.';
  }
}
</script>
