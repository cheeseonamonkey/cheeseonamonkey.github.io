<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Compressor</title>

<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0a0f1a">

<script src="https://cdn.tailwindcss.com"></script>

<style>
html{touch-action:manipulation;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
body{background:#0a0f1a;color:#e5e7eb}
.card{background:#111827;border:1px solid #1f2937;border-radius:8px;padding:14px}
input[type=range]{accent-color:#6366f1}
</style>

<script>
(()=>{

/* ---------- QUOTES (LIGHTWEIGHT) --------- */
const Q=[
"Less is learned.","Seek structure, not size.","Simple beats clever.",
"Meaning survives compression.","Find the signal.","Entropy always wins."
];
const showQuote=()=>{
  const el=document.createElement("div");
  el.textContent=Q[Math.random()*Q.length|0];
  el.style="position:fixed;top:10px;right:10px;font-size:11px;opacity:.7";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3500);
};
addEventListener("DOMContentLoaded",showQuote);

/* ---------- CORE --------- */

const $=id=>document.getElementById(id);
let ffmpeg=null,ffReady=false,currentFile=null,lastURL=null;
const meta={ready:false,w:0,h:0};

const log=m=>{logOutput.textContent+=m+"\n";logOutput.scrollTop=99999};
const status=s=>statusLabel.textContent=s;
const prog=p=>{
  p=Math.max(0,Math.min(100,p));
  bar.style.width=p+"%"; barLabel.textContent=p|0;
};

const fmt=x=>{
  if(!x) return "–";
  const u=["B","KB","MB","GB"]; let i=0;
  while(x>=1024&&i<u.length-1){x/=1024;i++}
  return (x>10?x.toFixed(0):x.toFixed(1))+" "+u[i];
};

/* ---------- FFmpeg Loader (NON-BLOCKING) ---------- */

async function loadFF(){
  if(ffReady) return;
  status("Loading engine…");

  const db=await new Promise(r=>{
    const req=indexedDB.open("ffmpeg-cache",1);
    req.onupgradeneeded=e=>e.target.result.createObjectStore("core");
    req.onsuccess=e=>r(e.target.result);
  });

  const get=k=>new Promise(r=>{
    const s=db.transaction("core").objectStore("core").get(k);
    s.onsuccess=e=>r(e.target.result);
  });

  let wasm=await get("wasm");
  if(!wasm){
    wasm=await fetch("https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.wasm").then(r=>r.arrayBuffer());
    db.transaction("core","readwrite").objectStore("core").put(wasm,"wasm");
  }

  const {createFFmpeg}=await import("https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.mjs");

  ffmpeg=createFFmpeg({
    corePath:"https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js",
    wasmBinary:wasm
  });

  ffmpeg.setLogger(({message})=>log(message));
  ffmpeg.setProgress(({ratio})=>prog(ratio*100));

  await ffmpeg.load();

  // warm-up
  await ffmpeg.run("-version").catch(()=>{});

  ffReady=true;
  status("Ready.");
}

/* preload ASAP without freezing */
requestIdleCallback(loadFF);
document.addEventListener("visibilitychange",()=>!ffReady&&loadFF());

const cleanFS=()=>{
  if(!ffReady) return;
  try{ ffmpeg.FS("readdir",".").forEach(f=>![".",".."].includes(f)&&ffmpeg.FS("unlink",f)); }catch{}
};

/* ---------- OPTIONS ---------- */

const opts=()=>({
  mute: mute.checked,
  bitrate:+audioBitrate.value,
  rp:+resPercent.value,
  speed:+speed.value,
  fmt: outputFormat.value,
  comp: compressionLevel.value,
  color:+colorSlider.value
});

/* ---------- SIZE ESTIMATE ---------- */

function estimate(){
  if(!currentFile) return;
  const o=opts();
  let s=currentFile.size;
  const durF=1/o.speed;
  const areaF=o.rp/100**2;
  const compF={fast:1.1,balanced:1,strong:.7,max:.5}[o.comp];
  const audioF=o.mute?.9:1;
  const colorF=o.color==1?.9:o.color==2?.8:1;

  const est=s*durF*areaF*compF*audioF*colorF;
  estSize.textContent=fmt(est);
}

/* ---------- COMMAND ---------- */

function args(inf,outf,o){
  const vf=[],af=[];
  const sc=o.rp/100;
  if(sc!==1) vf.push(`scale=trunc(iw*${sc}/2)*2:trunc(ih*${sc}/2)*2`);
  if(o.speed!==1){
    vf.push(`setpts=PTS/${o.speed}`);
    if(!o.mute) af.push(`atempo=${Math.min(o.speed,2)}`);
  }
  if(o.color===1) vf.push("lut=r=bitand(val\\,240):g=bitand(val\\,240):b=bitand(val\\,240)");
  if(o.color===2) vf.push("lut=r=bitand(val\\,192):g=bitand(val\\,192):b=bitand(val\\,192)");

  const a=["-y","-i",inf];
  if(vf.length) a.push("-vf",vf.join(","));
  if(af.length) a.push("-af",af.join(","));
  o.mute?a.push("-an"):a.push("-b:a",o.bitrate+"k");

  if(o.fmt==="webm"){
    const crf={fast:28,balanced:32,strong:38,max:42}[o.comp];
    a.push("-c:v","libvpx-vp9","-b:v","0","-crf",crf,"-c:a","libopus");
  } else {
    const crf={fast:20,balanced:23,strong:28,max:32}[o.comp];
    a.push("-c:v","libx264","-preset","medium","-crf",crf,"-movflags","faststart","-c:a","aac");
  }
  a.push(outf); return a;
}

/* ---------- MAIN ---------- */

async function compress(){
  if(!currentFile) return;

  compressBtn.disabled=true;
  spinner.classList.remove("hidden");
  prog(0);
  status("Preparing…");

  await loadFF();
  cleanFS();

  const input=currentFile.name;
  ffmpeg.FS("writeFile",input,new Uint8Array(await currentFile.arrayBuffer()));

  const o=opts();
  const out=input.replace(/\..+$/,"_compressed."+o.fmt);
  const cmd=args(input,out,o);

  log("$ ffmpeg "+cmd.join(" "));
  status("Compressing…");

  try{
    await ffmpeg.run(...cmd);
    const data=ffmpeg.FS("readFile",out);
    const blob=new Blob([data.buffer],{type:"video/"+o.fmt});

    lastURL&&URL.revokeObjectURL(lastURL);
    lastURL=URL.createObjectURL(blob);

    preview.src=lastURL;
    downloadLink.href=lastURL;
    downloadLink.download=out;
    downloadLink.classList.remove("hidden");

    compSize.textContent=fmt(data.length);
    prog(100);
    status("Done.");
  }catch(e){
    log("ERROR: "+e);
    status("Failed.");
  }finally{
    spinner.classList.add("hidden");
    compressBtn.disabled=false;
    cleanFS();
  }
}

/* ---------- EVENTS ---------- */

fileInput.onchange=e=>{
  currentFile=e.target.files[0];
  fileInfo.textContent=currentFile.name+" • "+fmt(currentFile.size);
  origSize.textContent=fmt(currentFile.size);
  const u=URL.createObjectURL(currentFile);
  probeVideo.src=u;
  probeVideo.onloadedmetadata=()=>{
    meta.ready=true;
    URL.revokeObjectURL(u);
    estimate();
  };
};

[audioBitrate,resPercent,speed,compressionLevel,colorSlider].forEach(e=>e.oninput=estimate);
mute.onchange=estimate;
compressBtn.onclick=e=>{e.preventDefault();compress()};

})();
</script>
</head>

<body class="p-4 max-w-md mx-auto space-y-3">

<h1 class="text-lg font-semibold">Video Compressor</h1>

<div class="card space-y-2">
  <input id="fileInput" type="file" accept="video/*">
  <p id="fileInfo" class="text-xs text-gray-400"></p>

  <label><input id="mute" type="checkbox"> Mute</label>
  <input id="audioBitrate" type="range" min="48" max="192" step="16" value="128">

  <input id="resPercent" type="range" min="25" max="100" step="5" value="100">
  <input id="speed" type="range" min="1" max="3" step="0.05" value="1">

  <select id="outputFormat">
    <option value="mp4">MP4</option>
    <option value="webm">WebM</option>
  </select>

  <select id="compressionLevel">
    <option value="fast">Fast</option>
    <option value="balanced" selected>Balanced</option>
    <option value="strong">Strong</option>
    <option value="max">Max</option>
  </select>

  <input id="colorSlider" type="range" min="0" max="2">

  <button id="compressBtn" class="bg-indigo-600 w-full rounded py-2">Compress</button>
  <div class="h-2 bg-gray-700 rounded overflow-hidden">
    <div id="bar" class="h-2 bg-indigo-500"></div>
  </div>
  <p id="barLabel" class="text-xs">0%</p>
  <p id="statusLabel" class="text-xs text-gray-400">Idle</p>
</div>

<div class="card space-y-2">
  <video id="preview" controls></video>
  <a id="downloadLink" class="hidden bg-emerald-600 text-center block py-2 rounded">Download</a>

  <div class="text-xs">
    Original: <span id="origSize">–</span><br>
    Estimated: <span id="estSize">–</span><br>
    Final: <span id="compSize">–</span>
  </div>
</div>

<details class="card">
  <summary>FFmpeg Log</summary>
  <pre id="logOutput" class="text-[10px]"></pre>
</details>

<video id="probeVideo" class="hidden"></video>

</body>
</html>
