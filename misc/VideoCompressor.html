
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Compressor</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#0a0f1a">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>
<style>
html{-webkit-overflow-scrolling:touch;touch-action:manipulation;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
html,body{-webkit-text-size-adjust:100%;text-size-adjust:100%}
body{background:#0a0f1a;color:#e5e7eb}
.card{background:#111827;border:1px solid #1f2937;border-radius:8px;padding:16px}
input[type=range]{accent-color:#6366f1;height:28px;cursor:pointer}
input[type=range]::-webkit-slider-runnable-track{height:8px;border-radius:4px}
input[type=range]::-moz-range-track{height:8px;border-radius:4px}
.tip-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:#374151;font-size:10px;cursor:help;flex-shrink:0}
.tip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#374151;color:#d1d5db;padding:8px 10px;font-size:11px;border-radius:6px;white-space:pre-line;z-index:20;min-width:160px;max-width:220px;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.tip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#374151}
.tip-wrap:hover .tip,.tip-wrap:focus .tip{display:block}
.tip-left .tip{left:0;transform:none}.tip-left .tip::after{left:10px;transform:none}
.tip-right .tip{left:auto;right:0;transform:none}.tip-right .tip::after{left:auto;right:10px;transform:none}
.res-btn{background:#1f2937;border:1px solid #374151;border-radius:4px;padding:3px 8px;font-size:10px;cursor:pointer}
.res-btn:hover{background:#374151}
</style>
</head>

<body class="p-4 max-w-md mx-auto space-y-4">

<h1 class="text-xl font-semibold">Video Compressor</h1>
<p class="text-xs text-gray-400">Local FFmpeg processing. No upload.</p>

<div class="card space-y-3">

  <!-- FILE -->
  <div>
    <label class="text-xs text-gray-400">Source video</label>
    <input id="fileInput" type="file" accept="video/*" class="mt-1 text-sm">
    <p id="fileInfo" class="text-xs text-gray-500 mt-1">No file selected.</p>
  </div>

  <!-- AUDIO -->
  <div>
    <div class="flex justify-between items-center">
      <span class="text-sm font-medium flex gap-1 items-center">Audio
        <span class="tip-wrap tip-left" tabindex="0">?<span class="tip">Audio bitrate in kbps.
48 = low quality, small
128 = good (default)
192 = high quality, larger</span></span>
      </span>
      <label class="text-xs flex gap-1 items-center"><input id="muteAudio" type="checkbox"> Remove</label>
    </div>
    <div id="audioBitrateRow">
      <div class="flex justify-between text-[11px] text-gray-400">
        <span>Bitrate</span>
        <span><span id="audioBitrateLabel">128</span> kbps</span>
      </div>
      <input id="audioBitrate" type="range" min="48" max="192" step="48" value="128" class="w-full">
    </div>
    <p id="audioMutedHint" class="hidden text-[10px] text-amber-400">Audio will be removed</p>
  </div>

  <!-- RESOLUTION -->
  <div>
    <div class="flex justify-between text-[11px] text-gray-400 mb-1">
      <span class="flex gap-1 items-center">Resolution
        <span class="tip-wrap tip-left" tabindex="0">?<span class="tip">Downscales via FFmpeg.
Even dimensions enforced.
Lower = smaller file.</span></span>
      </span>
      <span id="resolutionActualLabel">Original</span>
    </div>
    <input id="resolutionPercent" type="range" min="10" max="100" step="5" value="100" class="w-full">
    <div id="resButtons" class="hidden flex gap-1 mt-2 flex-wrap">
      <button class="res-btn" data-h="144">144p</button>
      <button class="res-btn" data-h="240">240p</button>
      <button class="res-btn" data-h="480">480p</button>
      <button class="res-btn" data-h="720">720p</button>
      <button class="res-btn" data-h="1080">1080p</button>
    </div>
  </div>

  <!-- CRF -->
  <div>
    <div class="flex justify-between text-[11px] text-gray-400 mb-1">
      <span class="flex gap-1 items-center">CRF
        <span class="tip-wrap tip-left" tabindex="0">?<span class="tip">Constant Rate Factor.
18 = near lossless, large
24 = good (default)
30 = smaller, visible loss
38+ = very compressed</span></span>
      </span>
      <span id="crfLabel">24</span>
    </div>
    <input id="crf" type="range" min="18" max="42" step="2" value="24" class="w-full">
  </div>

  <!-- SPEED -->
  <div>
    <div class="flex justify-between text-[11px] text-gray-400 mb-1">
      <span class="flex gap-1 items-center">Speed
        <span class="tip-wrap tip-left" tabindex="0">?<span class="tip">Speed up video playback.
Audio adjusted via atempo.
Reduces duration.</span></span>
      </span>
      <span><span id="speedLabel">1.00</span>x</span>
    </div>
    <input id="speed" type="range" min="100" max="175" step="5" value="100" class="w-full">
  </div>

  <!-- FORMAT -->
  <div class="flex gap-2 text-xs items-center">
    <span class="tip-wrap tip-left" tabindex="0">?<span class="tip">MP4/H.264: Fast, universal.
WebM/VP9: Smaller, slower.</span></span>
    <span class="text-[11px] text-gray-400">Format</span>
    <select id="outputFormat" class="bg-gray-900 border border-gray-700 rounded px-2 py-1 ml-auto">
      <option value="mp4">MP4 (H.264)</option>
      <option value="webm">WebM (VP9)</option>
    </select>
  </div>

  <!-- CHECKBOXES -->
  <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-300">
    <label class="flex gap-1 items-center">
      <input id="fastStart" type="checkbox" checked> Fast start
      <span class="tip-wrap tip-left" tabindex="0">?<span class="tip">Moves moov atom to start.
Enables streaming before
full download. Recommended.</span></span>
    </label>
    <label class="flex gap-1 items-center">
      <input id="stripMeta" type="checkbox"> Strip metadata
      <span class="tip-wrap tip-right" tabindex="0">?<span class="tip">Removes EXIF, GPS, camera
info, timestamps, etc.
Good for privacy.</span></span>
    </label>
  </div>

  <!-- ESTIMATE -->
  <div id="estimateRow" class="hidden text-xs text-gray-400 bg-gray-800/50 rounded px-3 py-2">
    Est: <span id="estimateLabel"></span>
    <span class="text-gray-500">(<span id="estimateReduction"></span>)</span>
  </div>

  <!-- ACTION -->
  <button id="compressBtn" disabled class="w-full bg-indigo-600 rounded py-2 text-sm font-semibold flex justify-center gap-2 disabled:opacity-50">
    <span>Compress</span>
    <span id="spinner" class="hidden h-4 w-4 border-2 border-white/40 border-t-transparent rounded-full animate-spin"></span>
  </button>

  <div class="flex items-center gap-3">
    <div class="flex-1 h-3 bg-gray-700 rounded overflow-hidden">
      <div id="progressBar" class="h-3 bg-indigo-500 transition-all" style="width:0%"></div>
    </div>
    <span id="progressLabel" class="text-xs w-10 text-right text-gray-400">0%</span>
  </div>

  <p id="status" class="text-xs text-gray-400">Loading FFmpeg...</p>
</div>

<!-- RESULT -->
<div class="card space-y-2">
  <video id="preview" class="w-full bg-black rounded" controls playsinline></video>
  <p id="sizeInfo" class="hidden text-xs text-gray-400 text-center"></p>
  <a id="downloadLink" class="hidden w-full text-center bg-emerald-600 py-2 rounded text-sm font-semibold block">Download</a>
</div>

<!-- ERROR LOG (persistent, subtle) -->
<div id="errorBox" class="card space-y-1 text-[11px] text-red-300 bg-red-900/10 border-red-700/40 hidden">
  <div class="font-semibold text-red-200">Errors (most recent first)</div>
  <pre id="errorText" class="whitespace-pre-wrap break-all text-red-200/90"></pre>
</div>

<video id="probeVideo" class="hidden"></video>

<script>
const $=id=>document.getElementById(id),
els={
  file:$("fileInput"),fileInfo:$("fileInfo"),ab:$("audioBitrate"),abLbl:$("audioBitrateLabel"),
  mute:$("muteAudio"),abRow:$("audioBitrateRow"),abHint:$("audioMutedHint"),rp:$("resolutionPercent"),
  rLab:$("resolutionActualLabel"),resBtn:$("resButtons"),crf:$("crf"),crfLbl:$("crfLabel"),
  speed:$("speed"),speedLbl:$("speedLabel"),fmt:$("outputFormat"),fastStart:$("fastStart"),
  stripMeta:$("stripMeta"),btn:$("compressBtn"),spin:$("spinner"),bar:$("progressBar"),
  barLbl:$("progressLabel"),status:$("status"),preview:$("preview"),dl:$("downloadLink"),
  probe:$("probeVideo"),sizeInfo:$("sizeInfo"),estRow:$("estimateRow"),estLbl:$("estimateLabel"),
  estRed:$("estimateReduction"),errBox:$("errorBox"),errText:$("errorText")
};

let ffmpeg=null,ffReady=false,currentFile=null,meta={w:0,h:0},prevUrl=null;
const errorLines=[];

const setStatus=s=>els.status.textContent=s;
const setProgress=p=>{els.bar.style.width=p+"%";els.barLbl.textContent=p.toFixed(0)+"%";};
const fmtSize=b=>b<1e6?(b/1e3).toFixed(1)+" KB":(b/1e6).toFixed(2)+" MB";
const updateBtn=()=>els.btn.disabled=!ffReady||!currentFile;
const calcRes=p=>({w:Math.floor(meta.w*p/100/2)*2,h:Math.floor(meta.h*p/100/2)*2});

function formatError(err){
  if(!err)return "Unknown error";
  if(err.message)return err.message;
  if(typeof err==="string")return err;
  try{return JSON.stringify(err);}catch{return String(err);}
}

function logError(context,err){
  const msg=formatError(err);
  const line=`[${new Date().toLocaleTimeString()}] ${context}: ${msg}`;
  errorLines.unshift(line);
  if(errorLines.length>50)errorLines.pop();
  els.errText.textContent=errorLines.join("\n\n");
  els.errBox.classList.remove("hidden");
  console.error(context,err);
  setStatus(`Error in ${context}: ${msg}`);
}

function updateResLabel(){
  const p=+els.rp.value,r=calcRes(p);
  els.rLab.textContent=meta.w?`${p}% | ${r.w}x${r.h}`:"Original";
  updateEstimate();
}

function updateEstimate(){
  if(!currentFile){els.estRow.classList.add("hidden");return;}
  const rp=+els.rp.value/100,crf=+els.crf.value,speed=+els.speed.value/100;
  const est=Math.max(currentFile.size*rp*rp*Math.pow(2,(24-crf)/6)/speed*0.85,currentFile.size*0.05);
  els.estLbl.textContent=fmtSize(est);
  const red=((1-est/currentFile.size)*100).toFixed(0);
  els.estRed.textContent=red>0?`~${red}% smaller`:`~${Math.abs(red)}% larger`;
  els.estRow.classList.remove("hidden");
}

// FFmpeg init with proper capability check
(async()=>{
  try{
    const sabAvailable = typeof SharedArrayBuffer !== "undefined";
    const coiSupported = typeof crossOriginIsolated !== "undefined";
    const coi = coiSupported && crossOriginIsolated === true;

    if(!sabAvailable || !coi){
      // This is *not* fixable from inside the page; needs headers or a different core.
      const reason = !sabAvailable
        ? "SharedArrayBuffer is not available in this browser/WebView."
        : "Page is not cross-origin isolated (crossOriginIsolated=false).";

      const hint = [
        "ffmpeg.wasm (CDN build) needs SharedArrayBuffer + cross-origin isolation.",
        "Typical fixes (outside this HTML file):",
        "- Serve over HTTPS with headers:",
        "  Cross-Origin-Opener-Policy: same-origin",
        "  Cross-Origin-Embedder-Policy: require-corp",
        "- Or open in a full browser (Chrome/Firefox) via a real URL, not an in-app viewer or file://.",
        "- Or switch this app to a single-thread or ffmpeg.js build."
      ].join("\n");

      logError("FFmpeg load", reason + "\n\n" + hint);
      setStatus("FFmpeg not supported in this browser context.");
      updateBtn(); // keeps Compress disabled
      return;
    }

    if(!window.FFmpeg) throw new Error("FFmpeg script not loaded (window.FFmpeg undefined)");

    ffmpeg = FFmpeg.createFFmpeg({
      log:false,
      corePath:"https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js"
    });
    ffmpeg.setProgress(({ratio})=>setProgress(Math.max(0,ratio*100)));
    await ffmpeg.load();
    ffReady=true;
    setStatus("FFmpeg loaded. Ready.");
    updateBtn();
  }catch(e){
    logError("FFmpeg load",e);
  }
})();

function buildArgs(input,out,o){
  const vf=[],af=[];
  if(o.rp!==100)vf.push(`scale=trunc(iw*${o.rp/100}/2)*2:trunc(ih*${o.rp/100}/2)*2`);
  if(o.speed!==1){
    vf.push(`setpts=PTS/${o.speed}`);
    if(!o.mute)af.push(`atempo=${o.speed}`);
  }
  const args=["-y","-i",input];
  if(vf.length)args.push("-vf",vf.join(","));
  if(af.length)args.push("-af",af.join(","));
  o.mute?args.push("-an"):args.push("-b:a",o.bitrate+"k");
  args.push("-c:v",o.fmt==="webm"?"libvpx-vp9":"libx264","-crf",o.crf);
  if(o.fmt==="mp4"&&o.fastStart)args.push("-movflags","+faststart");
  if(o.stripMeta)args.push("-map_metadata","-1");
  return args.concat(out);
}

async function compress(){
  if(!currentFile||!ffReady)return;
  els.btn.disabled=true;
  els.spin.classList.remove("hidden");
  setProgress(0);
  setStatus("Compressing...");

  if(prevUrl){URL.revokeObjectURL(prevUrl);prevUrl=null;}
  els.dl.classList.add("hidden");
  els.sizeInfo.classList.add("hidden");

  const o={
    mute:els.mute.checked,
    bitrate:+els.ab.value,
    rp:+els.rp.value,
    crf:+els.crf.value,
    speed:+els.speed.value/100,
    fmt:els.fmt.value,
    fastStart:els.fastStart.checked,
    stripMeta:els.stripMeta.checked
  };
  const out="out."+o.fmt;

  try{
    const buf=new Uint8Array(await currentFile.arrayBuffer());
    ffmpeg.FS("writeFile",currentFile.name,buf);
    await ffmpeg.run(...buildArgs(currentFile.name,out,o));
    const data=ffmpeg.FS("readFile",out);
    try{ffmpeg.FS("unlink",currentFile.name);}catch(e){logError("FS unlink input",e);}
    try{ffmpeg.FS("unlink",out);}catch(e){logError("FS unlink output",e);}
    const blob=new Blob([data],{type:"video/"+o.fmt});
    prevUrl=URL.createObjectURL(blob);
    els.preview.src=prevUrl;
    els.dl.href=prevUrl;
    els.dl.download=out;
    els.dl.classList.remove("hidden");
    const diff=((1-blob.size/currentFile.size)*100).toFixed(0);
    els.sizeInfo.textContent=`${fmtSize(currentFile.size)} -> ${fmtSize(blob.size)} (${diff>0?diff+"% smaller":Math.abs(diff)+"% larger"})`;
    els.sizeInfo.classList.remove("hidden");
    setProgress(100);
    setStatus("Done.");
  }catch(e){
    logError("Compression",e);
    try{ffmpeg.FS("unlink",currentFile.name);}catch(_){}
    try{ffmpeg.FS("unlink",out);}catch(_){}
  }
  els.spin.classList.add("hidden");
  updateBtn();
}

els.file.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  currentFile=f;
  meta={w:0,h:0};
  els.fileInfo.textContent=`${f.name} (${fmtSize(f.size)})`;

  const u=URL.createObjectURL(f);
  els.probe.src=u;
  els.probe.onloadedmetadata=()=>{
    meta.w=els.probe.videoWidth;
    meta.h=els.probe.videoHeight;
    URL.revokeObjectURL(u);
    updateResLabel();
    els.resBtn.classList.remove("hidden");
  };
  els.probe.onerror=err=>{
    logError("Video metadata probe",err||"onloadedmetadata failed");
    currentFile=null;
    URL.revokeObjectURL(u);
    updateBtn();
  };
  updateBtn();
  updateEstimate();
};

els.resBtn.onclick=e=>{
  const h=+e.target.dataset.h;
  if(!h||!meta.h)return;
  els.rp.value=Math.max(10,Math.min(100,Math.round(h/meta.h*100/5)*5));
  updateResLabel();
};

els.ab.oninput=()=>els.abLbl.textContent=els.ab.value;
els.mute.onchange=()=>{
  els.abRow.classList.toggle("hidden",els.mute.checked);
  els.abHint.classList.toggle("hidden",!els.mute.checked);
};
els.rp.oninput=updateResLabel;
els.crf.oninput=()=>{els.crfLbl.textContent=els.crf.value;updateEstimate();};
els.speed.oninput=()=>{els.speedLbl.textContent=(+els.speed.value/100).toFixed(2);updateEstimate();};
els.btn.onclick=compress;
</script>
</body>
</html>
