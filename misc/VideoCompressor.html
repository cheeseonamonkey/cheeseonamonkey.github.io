<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Compressor</title>

<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#0a0f1a">

<script src="https://cdn.tailwindcss.com"></script>

<style>
html{-webkit-overflow-scrolling:touch;touch-action:manipulation;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
html,body{-webkit-text-size-adjust:100%;text-size-adjust:100%}
body{background:#0a0f1a;color:#e5e7eb}
.card{background:#111827;border:1px solid #1f2937;border-radius:10px;padding:16px}
input[type=range]{accent-color:#6366f1}
.tip{font-size:10px;color:#9ca3af}
</style>
</head>

<body class="p-4 max-w-md mx-auto space-y-4">

<h1 class="text-xl font-semibold">Video Compressor</h1>
<p class="text-xs text-gray-400">Local processing. Mobile-friendly.</p>

<div class="card space-y-3">

  <!-- FILE -->
  <div>
    <label class="text-xs text-gray-400">Source video</label>
    <input id="fileInput" type="file" accept="video/*" class="mt-1 text-sm">
    <p id="fileInfo" class="text-xs text-gray-500 mt-1">No file selected.</p>
  </div>

  <!-- AUDIO -->
  <div>
    <div class="flex justify-between items-center">
      <span class="text-sm">Audio</span>
      <label class="text-xs flex items-center gap-1">
        <input id="muteAudio" type="checkbox"> Remove
      </label>
    </div>
    <div id="audioBitrateRow">
      <div class="flex justify-between text-[11px] text-gray-400">
        <span>Bitrate</span>
        <span><span id="audioBitrateLabel">128</span> kbps</span>
      </div>
      <input id="audioBitrate" type="range" min="48" max="192" step="16" value="128" class="w-full">
    </div>
    <p id="audioMutedHint" class="hidden text-[10px] text-amber-400">Audio removed</p>
    <p class="tip">AAC/Opus encode only. No passthrough.</p>
  </div>

  <!-- RESOLUTION -->
  <div>
    <div class="flex justify-between text-[11px] text-gray-400">
      <span>Resolution</span>
      <span><span id="resolutionPercentLabel">100</span>% · <span id="resolutionActualLabel">Original</span></span>
    </div>
    <input id="resolutionPercent" type="range" min="25" max="100" step="5" value="100" class="w-full">
    <div class="flex gap-2 text-xs mt-2">
      <button id="resPreset480" class="flex-1 border rounded py-1">480p</button>
      <button id="resPreset720" class="flex-1 border rounded py-1">720p</button>
      <button id="resPreset1080" class="flex-1 border rounded py-1">1080p</button>
    </div>
    <p class="tip">Scale keeps even dimensions for codec safety.</p>
  </div>

  <!-- SPEED -->
  <div>
    <div class="flex justify-between text-[11px] text-gray-400">
      <span>Speed</span>
      <span><span id="speedLabel">1.00</span>x</span>
    </div>
    <input id="speed" type="range" min="0" max="9" step="1" value="0" class="w-full">
    <p class="tip">Snapped atempo/setpts steps. Audio stays synced.</p>
  </div>

  <!-- FORMAT -->
  <div class="grid grid-cols-2 gap-2 text-xs">
    <select id="outputFormat" class="bg-gray-900 border rounded px-2 py-1">
      <option value="mp4">MP4 (H.264)</option>
      <option value="webm">WebM (VP9)</option>
    </select>

    <select id="compressionLevel" class="bg-gray-900 border rounded px-2 py-1">
      <option value="fast">Fast</option>
      <option value="balanced" selected>Balanced</option>
      <option value="strong">Strong</option>
      <option value="max">Max</option>
    </select>
  </div>

  <!-- ACTION -->
  <button id="compressBtn" class="w-full bg-indigo-600 rounded py-2 text-sm font-semibold flex justify-center gap-2">
    <span>Compress</span>
    <span id="spinner" class="hidden h-4 w-4 border-2 border-white/40 border-t-transparent rounded-full animate-spin"></span>
  </button>

  <div class="flex items-center gap-3">
    <div class="flex-1 h-2 bg-gray-700 rounded overflow-hidden">
      <div id="progressBar" class="h-2 bg-indigo-500" style="width:0%"></div>
    </div>
    <span id="progressLabel" class="text-xs w-10 text-right text-gray-400">0%</span>
  </div>

  <p id="status" class="text-xs text-gray-400">Idle.</p>
</div>

<!-- RESULT -->
<div class="card space-y-2">
  <video id="preview" class="w-full bg-black rounded" controls playsinline></video>
  <a id="downloadLink" class="hidden w-full text-center bg-emerald-600 py-2 rounded text-sm font-semibold block">Download</a>
</div>

<video id="probeVideo" class="hidden"></video>

<script>
const SPEED_STEPS=[1.05,1.1,1.15,1.2,1.3,1.4,1.55,1.75,1.8,2.0];

const $=x=>document.getElementById(x);
const els={
file:$("fileInput"),fileInfo:$("fileInfo"),
ab:$("audioBitrate"),abLbl:$("audioBitrateLabel"),mute:$("muteAudio"),
abRow:$("audioBitrateRow"),abHint:$("audioMutedHint"),
rp:$("resolutionPercent"),rpLbl:$("resolutionPercentLabel"),
rLab:$("resolutionActualLabel"),r480:$("resPreset480"),r720:$("resPreset720"),r1080:$("resPreset1080"),
speed:$("speed"),speedLbl:$("speedLabel"),
fmt:$("outputFormat"),comp:$("compressionLevel"),
btn:$("compressBtn"),spin:$("spinner"),
bar:$("progressBar"),barLbl:$("progressLabel"),
status:$("status"),preview:$("preview"),dl:$("downloadLink"),
probe:$("probeVideo")
};

let ffmpeg=null,ffReady=false,currentFile=null,meta={ready:false,w:0,h:0};

const setStatus=s=>els.status.textContent=s;
const setProgress=p=>{els.bar.style.width=p+"%";els.barLbl.textContent=p.toFixed(0)+"%"};

async function preloadFF(){
 try{
  setStatus("Loading FFmpeg…");
  const{createFFmpeg}=await import("https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.mjs");
  ffmpeg=createFFmpeg({log:false,corePath:"https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js"});
  ffmpeg.setProgress(({ratio})=>setProgress(ratio*100));
  await ffmpeg.load();
  ffReady=true;
  setStatus("Ready.");
 }catch(e){
  console.error(e);
  setStatus("FFmpeg failed to load.");
 }
}
requestIdleCallback(preloadFF,{timeout:1200});

function updateSpeed(){
 const v=SPEED_STEPS[+els.speed.value];
 els.speedLbl.textContent=v.toFixed(2);
 return v;
}

function updateRes(){
 const p=+els.rp.value;els.rpLbl.textContent=p;
 if(meta.ready){
  const s=p/100,w=2*Math.round(meta.w*s/2),h=2*Math.round(meta.h*s/2);
  els.rLab.textContent=h+"p";
 }
}

function getOpts(){
 return{
  mute:els.mute.checked,
  bitrate:+els.ab.value,
  rp:+els.rp.value,
  speed:updateSpeed(),
  fmt:els.fmt.value,
  comp:els.comp.value
 };
}

function buildArgs(input,out,o){
 const vf=[],af=[];
 if(o.rp!==100)vf.push(`scale=trunc(iw*${o.rp/100}/2)*2:trunc(ih*${o.rp/100}/2)*2`);
 if(o.speed!==1){vf.push(`setpts=PTS/${o.speed}`);if(!o.mute)af.push(`atempo=${Math.min(2,o.speed)}`);}
 const args=["-y","-i",input];
 if(vf.length)args.push("-vf",vf.join(","));
 if(af.length)args.push("-af",af.join(","));
 if(o.mute)args.push("-an");else args.push("-b:a",o.bitrate+"k");
 const crf={fast:20,balanced:23,strong:28,max:32}[o.comp];
 args.push("-c:v","libx264","-crf",crf,out);
 return args;
}

async function compress(){
 if(!currentFile)return alert("Pick a file.");
 if(!ffReady)return alert("FFmpeg still loading.");
 els.btn.disabled=true;els.spin.classList.remove("hidden");
 setProgress(0);setStatus("Compressing…");

 ffmpeg.FS("writeFile",currentFile.name,new Uint8Array(await currentFile.arrayBuffer()));
 const o=getOpts(),out="out.mp4",args=buildArgs(currentFile.name,out,o);
 await ffmpeg.run(...args);
 const data=ffmpeg.FS("readFile",out);
 const url=URL.createObjectURL(new Blob([data],{type:"video/mp4"}));

 els.preview.src=url;
 els.dl.href=url;
 els.dl.download=out;
 els.dl.classList.remove("hidden");

 els.spin.classList.add("hidden");els.btn.disabled=false;
 setProgress(100);setStatus("Done.");
}

els.file.onchange=e=>{
 currentFile=e.target.files[0];
 els.fileInfo.textContent=currentFile.name;
 const u=URL.createObjectURL(currentFile);
 els.probe.src=u;
 els.probe.onloadedmetadata=()=>{meta.ready=true;meta.w=els.probe.videoWidth;meta.h=els.probe.videoHeight;URL.revokeObjectURL(u);updateRes();}
};

els.ab.oninput=()=>els.abLbl.textContent=els.ab.value;
els.mute.onchange=()=>{els.abRow.classList.toggle("hidden",els.mute.checked);els.abHint.classList.toggle("hidden",!els.mute.checked)};
els.rp.oninput=updateRes;
els.r480.onclick=()=>{els.rp.value=45;updateRes()};
els.r720.onclick=()=>{els.rp.value=70;updateRes()};
els.r1080.onclick=()=>{els.rp.value=100;updateRes()};
els.speed.oninput=updateSpeed;
els.btn.onclick=compress;
</script>
</body>
</html>
