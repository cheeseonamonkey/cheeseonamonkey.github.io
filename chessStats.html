<!DOCTYPE html>
<html>

<head>
   <meta name="viewport" content="width=500, initial-scale=1.0, maximum-scale=2.0, minimum-scale=0.5, user-scalable=no">
   <title>Chess Games</title>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <style>
      body {
         font-family: Arial, sans-serif;
         background-color: #f2f2f2;
         margin: 0;
         padding: 20px;
      }

      h1 {
         color: #333;
         text-align: center;
      }

      #gamesContainer {
         background-color: #fff;
         padding: 20px;
         border: 1px solid #ccc;
         border-radius: 5px;
      }

      h3 {
         padding: 2px;

         margin-bottom: 10px;
      }

      a {
         color: #333;
         text-decoration: none;
      }

      p {
         margin: 0;
         margin-bottom: 10px;
      }

      pre {
         background-color: #f9f9f9;
         padding: 10px;
         border: 1px solid #ccc;
         border-radius: 5px;
         white-space: pre-wrap;
         overflow: auto;
      }

      .fen-image {
         float: right;
         max-width: 22%;
         height: auto;
         margin: 10px 0;
      }

      .copy-button {
         background-color: #333;
         color: #fff;
         border: none;
         padding: 5px 10px;
         border-radius: 5px;
         cursor: pointer;
         margin-top: 10px;
      }

      .copy-button:hover {
         background-color: #555;
      }

      .divChessGame {
         margin: 6px;
         padding: 8px;
         border: .4px solid rgba(0, 0, 0, 0.25);
      }
   </style>
</head>

<body>
   <h1>Chess Games</h1>
   <div id="gamesContainer"></div>

   <script>
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/';

      // Retrieve the username from the URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');

      // Call the getGames function with the username
      getGames(username);

      async function getGames(username) {
         var apiUrl = proxyUrl + 'https://api.chess.com/pub/player/' + username + '/games/archives';

         $.getJSON(apiUrl, function (data) {
            var archives = data.archives;
            var games = [];

            archives.forEach(async function (archiveUrl) {
               await $.getJSON(proxyUrl + archiveUrl, function (archiveData) {
                  games = games.concat(archiveData.games);
                  displayGames(games);
               });
            });
         });
      }
      async function getCompletion(textToSend) {
         const authkey = atob('c2stWXpWa2xiOTVGdHYwVW54ZDNUbDZUM0JsYmtGSjRYT2Zibk1vVHEzOFFFc0VQV0tJ')
         const response = await $.post({
            url: 'https://api.openai.com/v1/chat/completions',
            headers: {
               'Content-Type': 'application/json',
               'Authorization': 'Bearer ' + authkey
            },
            data: JSON.stringify({
               model: 'gpt-3.5-turbo',
               messages: [{ role: 'system', content: 'You are my expert AI chess tutor. Try not to reference too many specific moves and prefer to speak in terms of general strategy and tactics (but do reference some).' }, { role: 'user', content: textToSend }],
               temperature: 0.4
            }),
            dataType: 'json'
         });

         return response.choices[0].message.content;
      }

      function displayGames(games) {
         var gamesContainer = $('#gamesContainer');
         gamesContainer.empty();

         games.forEach(function (game) {
            var gameUrl = game.url;
            var pgn = game.pgn;
            var result = pgn.Termination;
            var fen = game.fen;

            var gameDiv = document.createElement('div');
            gameDiv.classList.add('divChessGame');

            var gameHeading = document.createElement('h3');
            var gameLink = document.createElement('a');
            gameLink.href = gameUrl;
            gameLink.textContent = 'Game: ' + game.white.username + ' (' + game.white.rating + ')' + ' vs. ' + game.black.username + ' (' + game.black.rating + ')';
            gameHeading.appendChild(gameLink);
            gameDiv.appendChild(gameHeading);

            var fenImage = document.createElement('img');
            fenImage.classList.add('fen-image');
            fenImage.src = 'https://fen2png.com/api/?fen=' + fen.replace("_", " ") + '&raw=true';
            fenImage.alt = fen;
            gameDiv.appendChild(fenImage);

            var resultParagraph = document.createElement('p');
            resultParagraph.textContent = 'Result: ' + result;
            gameDiv.appendChild(resultParagraph);

            var pgnPre = document.createElement('pre');
            pgnPre.textContent = pgn;
            gameDiv.appendChild(pgnPre);

            var copyButton = document.createElement('button');
            copyButton.classList.add('copy-button');
            copyButton.textContent = 'Copy Game';
            gameDiv.addEventListener('click', () => { copyMoves(game.pgn.toString()) })
            gameDiv.appendChild(copyButton);

            var gamesContainer = document.getElementById('gamesContainer');
            gamesContainer.prepend(gameDiv);
         });

      }

      async function copyMoves(pgn) {
         await navigator.clipboard.writeText(pgn.toString())
      }

   </script>
</body>

</html>
