<!DOCTYPE html>
<html>

<head>
   <script type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.16.0/js/md5.min.js"></script>

   <meta name="viewport" content="width=500, initial-scale=1.0, maximum-scale=2.0, minimum-scale=0.5, user-scalable=no">
   <title>Chess Games</title>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <style>
      body {
         font-family: Arial, sans-serif;
         background-color: #d4cece;
         margin: 0;
         padding: 20px;
         font-size: 1.05rem;
      }

      h1 {
         color: #333;
         text-align: center;
      }

      #gamesContainer {
         background-color: #fff;
         padding: 20px;
         border: 1px solid #ccc;
         border-radius: 5px;
      }

      h3 {
         padding: 2px;

         margin-bottom: 10px;
      }

      a {
         color: #333;
         text-decoration: none;
      }

      p {
         margin: 0;
         margin-bottom: 10px;
      }

      pre {
         background-color: #ac9d9d6e;
         padding: 10px;
         border: 1px solid #ccc;
         border-radius: 5px;
         white-space: pre-wrap;
         overflow: auto;
         font-size: 0.75em;
      }

      .fen-image {
         float: right;
         max-width: 33%;
         height: auto;
         margin: 10px 0;
      }

      .copy-button,
      button {
         font-weight: bold;
         font-size: 1.2em;
         background-color: #333;
         color: #fff;
         border: none;

         padding: 12px 19px;
         border-radius: 6px;
         cursor: pointer;
         margin: 10px;
         margin-right: 20px;
      }

      .copy-button:hover,
      button:hover {
         background-color: #555;
      }


      .divChessGame {
         margin: 6px;
         padding: 8px;
         border: .4px solid rgba(0, 0, 0, 0.25);
      }
   </style>
   <style>
      @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap');

      .strategy-container {
         font-family: 'Rubik', Arial, sans-serif;
         color: #333;
         box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
         padding: 10px;
      }

      .strategy-title,
      .strategy-grades,
      .strategy-takeaway {
         font-size: 1.15em;
         margin-top: 0.5em;
         color: #333;
      }

      .strategy-table {
         width: 100%;
         border-collapse: collapse;
      }

      .strategy-row {
         border-bottom: 1px solid #ccc;
      }

      .strategy-aspect {
         padding: 10px;
         width: 70%;
      }

      .strategy-rating {
         padding: 10px;
         width: 30%;
         text-align: right;
      }

      .strategy-grades {
         margin-top: 0.5em;
      }
   </style>
</head>

<body>
   <h1>Chess Games</h1>
   <small
      style="all: initial; margin-top: -5px; font-family:Georgia, 'Times New Roman', Times, serif; font-size: 0.85em; display: block; width: 100%; text-align: center;"><sup><a
            href="https://cors-anywhere.herokuapp.com/corsdemo">not
            working? try this.</a>
      </sup></small>
   <div id="gamesContainer"></div>

   <script>
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/';

      // Retrieve the username from the URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');

      // Call the getGames function with the username
      getGames(username);

      async function getGames(username) {
         var apiUrl = proxyUrl + 'https://api.chess.com/pub/player/' + username + '/games/archives';

         $.getJSON(apiUrl, function (data) {
            var archives = data.archives;
            var games = [];

            archives.forEach(async function (archiveUrl) {
               await $.getJSON(proxyUrl + archiveUrl, function (archiveData) {
                  games = games.concat(archiveData.games);
                  displayGames(games);
               });
            });
         });
      }
      async function getCompletion(gameText) {
         const authkey = atob('c2stWXpWa2xiOTVGdHYwVW54ZDNUbDZUM0JsYmtGSjRYT2Zibk1vVHEzOFFFc0VQV0tJ')
         const response = await $.post({
            url: 'https://api.openai.com/v1/chat/completions',
            headers: {
               'Content-Type': 'application/json',
               'Authorization': 'Bearer ' + authkey
            },
            data: JSON.stringify({
               model: 'gpt-3.5-turbo',
               messages: [
                  {
                     role: 'system',
                     content: "You are my brilliant Chess AI helper!\r\n\r\n### Using the PGN chess game supplied:\r\n\r\n\r\n\r\n- Name my chess style for this game (label \"Your style:\") (be mean if I lost)\r\n   - Rate aspects of my chess game style in these binary\/bipolar spectrums  (keep on previous label):\r\n      1. Aggressive vs Defensive\r\n      2. Tactical vs Positional\r\n      3. Dynamic vs Solid\r\n      4. Openings vs Endgames\r\n   Use `slightly`, `somewhat`, `very`, or `extremely`.\r\n- Grade me on these fundamental chess skills - use school grades like A+, C-, D, etc. (label \"Grades:\")(make the distribution a bit wider and exaggerate the extremes so I know what to work on):\r\n   1. Tactics\r\n   2. Calculation\r\n   3. Visualization\r\n   4. Strategy\r\n   5. Openings\r\n   6. Evaluation\r\n   7. Endgames\r\n\r\nGive me the one most important takeaway from this game (label \"Takeaway\")\r\n\r\n Do not echo the questions back in your responses - just make a report card. Use tables! Follow my example. In an HTML div please.\r\n\r\n---\r\n\r\nExample response html for a game:\r\n```\r\n<div class=\"strategy-container\"><p class=\"strategy-title\">Your style: \"The Passive Strategist\"<\/p><table class=\"strategy-table\"><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Aspect<\/td><td class=\"strategy-rating\">Rating<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Aggressive vs Defensive<\/td><td class=\"strategy-rating\">20% aggressive<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Tactical vs Positional<\/td><td class=\"strategy-rating\">40% positional<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Dynamic vs Solid<\/td><td class=\"strategy-rating\">30% solid<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Openings vs Endgames<\/td><td class=\"strategy-rating\">60% focused on openings<\/td><\/tr><\/table><p class=\"strategy-grades\">Grades:<\/p><table class=\"strategy-table\"><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Fundamental Skill<\/td><td class=\"strategy-rating\">Rating<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Tactics<\/td><td class=\"strategy-rating\">D+<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Calculation<\/td><td class=\"strategy-rating\">C-<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Visualization<\/td><td class=\"strategy-rating\">C-<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Strategy<\/td><td class=\"strategy-rating\">B<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Openings<\/td><td class=\"strategy-rating\">C+<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Evaluation<\/td><td class=\"strategy-rating\">C<\/td><\/tr><tr class=\"strategy-row\"><td class=\"strategy-aspect\">Endgames<\/td><td class=\"strategy-rating\">D-<\/td><\/tr><\/table><p class=\"strategy-takeaway\">Takeaway: Focus on improving your tactical skills and endgame play.<\/p><\/div>\r\n\r\n```\r\n" + ' \nMy chess username is: ' + username
                  },
                  {
                     role: 'user',
                     content: gameText
                  }
               ],
               temperature: 0.4,

            }),
            dataType: 'json'
         });

         return response.choices[0].message.content;
      }

      function displayGames(games) {
         var gamesContainer = $('#gamesContainer');
         gamesContainer.empty();

         games.forEach(function (game) {
            var gameUrl = game.url;
            var pgn = game.pgn;
            var result = pgn.Termination;
            var fen = game.fen;

            var gameDiv = document.createElement('div');
            gameDiv.classList.add('divChessGame');

            var gameHeading = document.createElement('h3');
            var gameLink = document.createElement('a');
            gameLink.href = gameUrl;
            gameLink.textContent = 'Game: ' + game.white.username + ' (' + game.white.rating + ')' + ' vs. ' + game.black.username + ' (' + game.black.rating + ')';
            gameHeading.appendChild(gameLink);
            gameDiv.appendChild(gameHeading);

            gameDiv.style.marginBottom = "29px";
            gameDiv.style.boxShadow = "1.5px 1.5px 1.3px 2.3px rgba(0,0,0,0.2)"

            var resultParagraph = document.createElement('p');
            resultParagraph.textContent = 'Result: ' + result;
            gameDiv.appendChild(resultParagraph);

            var pgnPre = document.createElement('pre');
            pgnPre.innerHTML = '<div style="display: inline; max-width: 60%; float:left;">' + pgn + '</div>';
            gameDiv.appendChild(pgnPre);

            var fenImage = document.createElement('img');
            fenImage.style.maxWidth = '33%'
            fenImage.classList.add('fen-image');
            fenImage.src = 'https://fen2png.com/api/?fen=' + fen.replace("_", " ") + '&raw=true';
            fenImage.alt = fen;
            pgnPre.appendChild(fenImage);

            var copyButton = document.createElement('button');
            copyButton.classList.add('copy-button');
            copyButton.textContent = 'Copy Game';
            gameDiv.addEventListener('click', () => { copyMoves(game.pgn.toString()) })
            gameDiv.appendChild(copyButton);

            //txtChat = document.createElement('textarea')
            //gameDiv.appendChild(txtChat)
            btnChat = document.createElement('button')
            btnChat.innerText = 'ai style analysis'
            btnChat.addEventListener('click', async (ev) => {
               ev.target.disabled = true;
               let tempEl = document.createElement('p')
               tempEl.innerHTML = "getting chat....<sup> this may take a minute...</sup>"
               gameDiv.appendChild(tempEl)

               let completionResult = await getCompletion("My chess game:\n```\n" + pgn + "\n```\n")

               tempEl.innerHTML = completionResult.toString();

            });
            gameDiv.appendChild(btnChat)


            var gamesContainer = document.getElementById('gamesContainer');
            gamesContainer.prepend(gameDiv);


         });

      }

      async function copyMoves(pgn) {
         await navigator.clipboard.writeText(pgn.toString())

      }

   </script>
</body>

</html>
